<div class="container mt-4">
  <h2>ğŸ‘¨â€âš•ï¸ Doktor Paneli</h2>

  <!-- Sekmeler -->
  <ul class="nav nav-tabs justify-content-center mt-3">
    <li class="nav-item">
      <a class="nav-link" [class.active]="activeTab === 'appointments'" (click)="setTab('appointments')">ğŸ“… Randevular</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" [class.active]="activeTab === 'patients'" (click)="setTab('patients')">ğŸ§ Hastalar</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" [class.active]="activeTab === 'medicalRecords'" (click)="setTab('medicalRecords')">ğŸ©º Medical Records</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" [class.active]="activeTab === 'prescriptions'" (click)="setTab('prescriptions')">ğŸ’Š ReÃ§eteler</a>
    </li>
  </ul>


  <div class="card mt-4 p-3 shadow-sm">

    <!-- RANDEVULAR SEKMESI -->
    <div *ngIf="activeTab === 'appointments'">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4>Randevu YÃ¶netimi</h4>
        <button class="btn btn-success btn-sm" (click)="openAppointmentForm()">
          {{ showAppointmentForm ? 'Listeye DÃ¶n' : 'â• Yeni Randevu' }}
        </button>
      </div>

      <!-- Arama ve filtre -->
      <div class="row mb-2" *ngIf="!showAppointmentForm">
        <div class="col-md-4">
          <input type="text" class="form-control" placeholder="Hasta adÄ± ara..." [(ngModel)]="searchText" (ngModelChange)="applyFilters()">
        </div>
        <div class="col-md-3">
          <select class="form-select" [(ngModel)]="statusFilter" (change)="applyFilters()">
            <option value="">TÃ¼m Durumlar</option>
            <option value="Scheduled">Scheduled</option>
            <option value="Completed">Completed</option>
            <option value="Canceled">Canceled</option>
          </select>
        </div>
      </div>

      <!-- Form -->
      <app-appointment-form
        *ngIf="showAppointmentForm"
        [appointment]="selectedAppointment"
        [doctorId]="doctorId"
        (formSubmitted)="onAppointmentSubmitted()"
        (cancelForm)="closeAppointmentForm()">
      </app-appointment-form>

      <!-- Tablo -->
      <table class="table table-striped mt-3" *ngIf="!showAppointmentForm && filteredAppointments.length > 0">
        <thead>
          <tr>
            <th (click)="sortAppointments('patient')" style="cursor:pointer">
              Hasta
              <span [ngClass]="{
                    'text-dark': sortField === 'patient' && sortDirection === 'asc',
                    'text-muted': sortField !== 'patient' || sortDirection !== 'asc'
                  }">â–²</span>
              <span [ngClass]="{
                    'text-dark': sortField === 'patient' && sortDirection === 'desc',
                    'text-muted': sortField !== 'patient' || sortDirection !== 'desc'
                  }">â–¼</span>
            </th>

            <th (click)="sortAppointments('date')" style="cursor:pointer">
              Tarih
              <span [ngClass]="{
                    'text-dark': sortField === 'date' && sortDirection === 'asc',
                    'text-muted': sortField !== 'date' || sortDirection !== 'asc'
                  }">â–²</span>
              <span [ngClass]="{
                    'text-dark': sortField === 'date' && sortDirection === 'desc',
                    'text-muted': sortField !== 'date' || sortDirection !== 'desc'
                  }">â–¼</span>
            </th>

            <th (click)="sortAppointments('status')" style="cursor:pointer">
              Durum
              <span [ngClass]="{
                    'text-dark': sortField === 'status' && sortDirection === 'asc',
                    'text-muted': sortField !== 'status' || sortDirection !== 'asc'
                  }">â–²</span>
              <span [ngClass]="{
                    'text-dark': sortField === 'status' && sortDirection === 'desc',
                    'text-muted': sortField !== 'status' || sortDirection !== 'desc'
                  }">â–¼</span>
            </th>

            <th>Ä°ÅŸlem</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let app of filteredAppointments">
            <td>
              <span
                [title]="'DoÄŸum Tarihi: ' + (app.patient.birthDate | date:'shortDate') + ' | Cinsiyet: ' + app.patient.gender">
                {{ app.patient.firstName }} {{ app.patient.lastName }}
              </span>
            </td>
            <td>{{ app.appointmentDate | date:'short' }}</td>
            <td>
              <select class="form-select form-select-sm"
                      [(ngModel)]="app.status"
                      (change)="updateAppointmentStatus(app)"
                      [ngClass]="{
                        'status-scheduled': app.status === 'Scheduled',
                        'status-completed': app.status === 'Completed',
                        'status-canceled': app.status === 'Canceled'
                      }">
                <option value="Scheduled">Scheduled</option>
                <option value="Completed">Completed</option>
                <option value="Canceled">Canceled</option>
              </select>
            </td>
            <td>
              <button class="btn btn-primary btn-sm me-2" (click)="openAppointmentForm(app)">GÃ¼ncelle</button>
              <button class="btn btn-danger btn-sm" (click)="deleteAppointment(app.id)">Sil</button>
            </td>
          </tr>
        </tbody>
      </table>

      <p *ngIf="!showAppointmentForm && filteredAppointments.length === 0">HenÃ¼z randevunuz yok veya filtreye uyan randevu bulunamadÄ±.</p>
    </div>

    <!-- HASTALAR SEKMESI -->
    <div *ngIf="activeTab === 'patients'">
      <h4>Hastalar</h4>
      <table class="table table-striped mt-3" *ngIf="patients.length > 0">
        <thead>
          <tr>
            <th>Ad</th>
            <th>Soyad</th>
            <th>DoÄŸum Tarihi</th>
            <th>Cinsiyet</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let p of patients">
            <td>{{ p.firstName }}</td>
            <td>{{ p.lastName }}</td>
            <td>{{ p.birthDate | date:'shortDate' }}</td>
            <td>{{ p.gender }}</td>
          </tr>
        </tbody>
      </table>
      <p *ngIf="patients.length === 0">HenÃ¼z hasta bulunmamaktadÄ±r.</p>
    </div>

    <!-- MEDICAL RECORD SEKMESÄ°-->
    <div *ngIf="activeTab === 'medicalRecords'">
      <!-- EÄŸer form veya gÃ¶rÃ¼ntÃ¼leme aÃ§Ä±k deÄŸilse tabloyu gÃ¶ster -->
      <div *ngIf="!showRecordForm && !showRecordView">
        <table class="table table-striped mt-3" *ngIf="medicalRecords.length>0">
          <thead>
            <tr><th>Hasta</th><th>TanÄ±</th><th>ReÃ§ete</th><th>Tarih</th><th>Ä°ÅŸlem</th></tr>
          </thead>
          <tbody>
            <tr *ngFor="let rec of medicalRecords">
              <td>{{rec.patient.firstName}} {{rec.patient.lastName}}</td>
              <td>{{rec.diagnosis}}</td>
              <td>{{rec.prescription}}</td>
              <td>{{rec.createdAt | date:'short'}}</td>
              <td>
                <button class="btn btn-primary btn-sm me-2" (click)="openRecordForm(rec)">GÃ¼ncelle</button>
                <button class="btn btn-info btn-sm" (click)="viewRecord(rec)">GÃ¶rÃ¼ntÃ¼le</button>
              </td>
            </tr>
          </tbody>
        </table>
        <p *ngIf="medicalRecords.length===0">HenÃ¼z kayÄ±t yok.</p>
      </div>

      <!-- KayÄ±t ekleme / gÃ¼ncelleme formu -->
      <app-medical-record-form
        *ngIf="showRecordForm"
        [record]="selectedRecord"
        (saved)="onRecordSaved()"
        (cancel)="closeRecordForm()">
      </app-medical-record-form>

      <!-- KayÄ±t gÃ¶rÃ¼ntÃ¼leme -->
      <div *ngIf="showRecordView">
        <button class="btn btn-secondary mb-3" (click)="closeRecordView()">â† KayÄ±tlara DÃ¶n</button>
        <app-medical-record-form
          [record]="selectedRecord"
          [viewMode]="true"
          (cancel)="closeRecordView()">
        </app-medical-record-form>
      </div>
    </div>


    <!-- REÃ‡ETELER -->
    <div *ngIf="activeTab === 'prescriptions'">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4>ReÃ§eteler</h4>
        <button class="btn btn-success btn-sm" (click)="showPrescriptionForm = !showPrescriptionForm">
          {{ showPrescriptionForm ? 'Listeye DÃ¶n' : 'â• Yeni ReÃ§ete' }}
        </button>
      </div>
<!--hahah-->
      <app-prescription-form *ngIf="showPrescriptionForm" [doctorId]="user.id" (saved)="showPrescriptionForm=false"></app-prescription-form>
      <app-prescription-list *ngIf="!showPrescriptionForm" [role]="'DOCTOR'" [userId]="user.id"></app-prescription-list>
    </div>

  </div>

</div>
